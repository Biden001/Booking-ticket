{% extends "base.html" %}

{% block title %}Äáº·t vÃ© - {{ movie.title }} - HUY CINEMA{% endblock %}

{% block content %}
<h1 class="page-title">ğŸŸï¸ Äáº·t vÃ© xem phim</h1>

<!-- Báº£ng Ä‘áº¿m ngÆ°á»£c giá»¯ chá»— -->
<div id="countdown-container" class="countdown-box">
    <div class="countdown-content">
        <span class="countdown-icon">â±ï¸</span>
        <span class="countdown-label">Thá»i gian giá»¯ chá»—:</span>
        <span id="countdown-timer" class="countdown-timer">10:00</span>
    </div>
    <div class="countdown-warning" id="countdown-warning" style="display: none;">
        âš ï¸ Sáº¯p háº¿t thá»i gian! Vui lÃ²ng hoÃ n táº¥t Ä‘áº·t vÃ©.
    </div>
</div>

<div style="text-align: center; margin-bottom: 2rem;">
    <h2>{{ movie.title }}</h2>
    <p>ğŸ“… {{ showtime.show_date }} - ğŸ• {{ showtime.show_time }} - ğŸ­ {{ showtime.theater }}</p>
    <p>ğŸ’° GiÃ¡ vÃ©: <strong style="color: var(--primary);">{{ "{:,.0f}".format(showtime.price) }} VND</strong></p>
</div>

<div class="screen">MÃ€N HÃŒNH</div>

<form method="POST" action="{{ url_for('book_seat') }}" id="booking-form">
    <input type="hidden" name="showtime_id" value="{{ showtime.id }}">
    
    <div class="seat-grid">
        {% for seat in seats %}
        <label class="seat {% if seat.status == 'booked' %}booked{% elif seat.status == 'held' and not seat.is_held_by_me %}held{% elif seat.is_held_by_me %}selected{% endif %}" data-seat-id="{{ seat.id }}">
            <input type="checkbox" name="seat_ids" value="{{ seat.id }}" 
                   {% if seat.status == 'booked' or (seat.status == 'held' and not seat.is_held_by_me) %}disabled{% endif %}
                   {% if seat.is_held_by_me %}checked{% endif %}
                   style="display: none;">
            {{ seat.seat_number }}
        </label>
        {% endfor %}
    </div>
    
    <div class="seat-legend">
        <div class="legend-item">
            <div class="legend-box" style="background: #2d5016;"></div>
            <span>Trá»‘ng</span>
        </div>
        <div class="legend-item">
            <div class="legend-box" style="background: var(--primary);"></div>
            <span>Äang chá»n</span>
        </div>
        <div class="legend-item">
            <div class="legend-box" style="background: var(--warning);"></div>
            <span>Äang giá»¯</span>
        </div>
        <div class="legend-item">
            <div class="legend-box" style="background: var(--danger);"></div>
            <span>ÄÃ£ Ä‘áº·t</span>
        </div>
    </div>
    
    <div style="text-align: center; margin-top: 2rem;">
        <p id="selected-info" style="margin-bottom: 1rem;">ChÆ°a chá»n gháº¿ nÃ o</p>
        <button type="submit" class="btn btn-primary" id="book-btn" disabled>ğŸŸï¸ Äáº·t vÃ©</button>
        <a href="{{ url_for('movie_detail', movie_id=movie.id) }}" class="btn btn-secondary">â† Quay láº¡i</a>
    </div>
</form>

<script>
// Showtime ID Ä‘á»ƒ gá»i API
const showtimeId = {{ showtime.id }};

// Äáº¿m ngÆ°á»£c 5 phÃºt giá»¯ chá»—
let timeLeft = 5 * 60; // 5 phÃºt = 300 giÃ¢y
const timerElement = document.getElementById('countdown-timer');
const warningElement = document.getElementById('countdown-warning');
const countdownContainer = document.getElementById('countdown-container');
const bookingForm = document.getElementById('booking-form');

function updateCountdown() {
    const minutes = Math.floor(timeLeft / 60);
    const seconds = timeLeft % 60;
    timerElement.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    
    // Cáº£nh bÃ¡o khi cÃ²n 2 phÃºt
    if (timeLeft <= 120 && timeLeft > 0) {
        warningElement.style.display = 'block';
        countdownContainer.classList.add('countdown-urgent');
    }
    
    // Háº¿t giá»
    if (timeLeft <= 0) {
        clearInterval(countdownInterval);
        timerElement.textContent = '00:00';
        countdownContainer.classList.add('countdown-expired');
        warningElement.innerHTML = 'âŒ Háº¿t thá»i gian giá»¯ chá»—! Äang chuyá»ƒn hÆ°á»›ng...';
        warningElement.style.display = 'block';
        
        // Disable form
        document.getElementById('book-btn').disabled = true;
        document.querySelectorAll('.seat input').forEach(input => input.disabled = true);
        
        // Redirect sau 3 giÃ¢y
        setTimeout(() => {
            window.location.href = "{{ url_for('movie_detail', movie_id=movie.id) }}";
        }, 3000);
    }
    
    timeLeft--;
}

const countdownInterval = setInterval(updateCountdown, 1000);
updateCountdown(); // Cháº¡y ngay láº­p tá»©c

// Xá»­ lÃ½ chá»n gháº¿ vá»›i API giá»¯ gháº¿
const selectedInfo = document.getElementById('selected-info');
const bookBtn = document.getElementById('book-btn');
const price = Number("{{ showtime.price }}");

// HÃ m gá»i API giá»¯ gháº¿
async function holdSeat(seatId) {
    try {
        const response = await fetch('/api/hold-seat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ seat_id: seatId, showtime_id: showtimeId })
        });
        const data = await response.json();
        return data.success;
    } catch (error) {
        console.error('Error holding seat:', error);
        return false;
    }
}

// HÃ m gá»i API bá» giá»¯ gháº¿
async function releaseSeat(seatId) {
    try {
        const response = await fetch('/api/release-seat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ seat_id: seatId })
        });
        const data = await response.json();
        return data.success;
    } catch (error) {
        console.error('Error releasing seat:', error);
        return false;
    }
}

// HÃ m cáº­p nháº­t tráº¡ng thÃ¡i gháº¿ tá»« server
async function refreshSeats() {
    try {
        const response = await fetch(`/api/get-seats/${showtimeId}`);
        const data = await response.json();
        
        data.seats.forEach(seatData => {
            const seatEl = document.querySelector(`.seat[data-seat-id="${seatData.id}"]`);
            if (!seatEl) return;
            
            const checkbox = seatEl.querySelector('input');
            
            // XÃ³a táº¥t cáº£ class tráº¡ng thÃ¡i
            seatEl.classList.remove('booked', 'held', 'selected');
            
            if (seatData.status === 'booked') {
                seatEl.classList.add('booked');
                checkbox.disabled = true;
                checkbox.checked = false;
            } else if (seatData.status === 'held' && !seatData.is_held_by_me) {
                seatEl.classList.add('held');
                checkbox.disabled = true;
                checkbox.checked = false;
            } else if (seatData.is_held_by_me) {
                seatEl.classList.add('selected');
                checkbox.disabled = false;
                checkbox.checked = true;
            } else {
                // available
                checkbox.disabled = false;
            }
        });
        
        updateInfo();
    } catch (error) {
        console.error('Error refreshing seats:', error);
    }
}

// Xá»­ lÃ½ click gháº¿
document.querySelectorAll('.seat').forEach(seat => {
    seat.addEventListener('click', async function(e) {
        if (this.classList.contains('booked') || this.classList.contains('held')) {
            return; // KhÃ´ng cho phÃ©p click gháº¿ Ä‘Ã£ Ä‘áº·t hoáº·c ngÆ°á»i khÃ¡c giá»¯
        }
        
        const checkbox = this.querySelector('input');
        const seatId = this.dataset.seatId;
        
        if (checkbox.checked) {
            // Äang chá»n -> bá» chá»n
            const success = await releaseSeat(seatId);
            if (success) {
                checkbox.checked = false;
                this.classList.remove('selected');
            }
        } else {
            // ChÆ°a chá»n -> chá»n
            const success = await holdSeat(seatId);
            if (success) {
                checkbox.checked = true;
                this.classList.add('selected');
            } else {
                alert('Gháº¿ Ä‘Ã£ Ä‘Æ°á»£c ngÆ°á»i khÃ¡c chá»n trÆ°á»›c. Äang cáº­p nháº­t...');
                refreshSeats();
            }
        }
        
        updateInfo();
    });
});

function updateInfo() {
    const selected = document.querySelectorAll('.seat.selected');
    if (selected.length > 0) {
        const seatNames = Array.from(selected).map(s => s.textContent.trim()).join(', ');
        const total = selected.length * price;
        selectedInfo.innerHTML = `Gháº¿: <strong>${seatNames}</strong> | Tá»•ng: <strong>${total.toLocaleString('vi-VN')} VND</strong>`;
        bookBtn.disabled = false;
    } else {
        selectedInfo.textContent = 'ChÆ°a chá»n gháº¿ nÃ o';
        bookBtn.disabled = true;
    }
}

// Tá»± Ä‘á»™ng cáº­p nháº­t tráº¡ng thÃ¡i gháº¿ má»—i 1 giÃ¢y
setInterval(refreshSeats, 1000);

// Cáº­p nháº­t info ban Ä‘áº§u
updateInfo();
</script>
{% endblock %}
