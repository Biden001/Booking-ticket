{% extends "base.html" %}

{% block title %}Admin - HUY CINEMA{% endblock %}

{% block content %}
<h1 class="page-title">‚öôÔ∏è Qu·∫£n tr·ªã h·ªá th·ªëng</h1>

<!-- Th·ªëng k√™ t·ªïng quan -->
<div class="stats-overview" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
    <div class="stat-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 1.5rem; border-radius: 15px; color: white; text-align: center; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);">
        <div style="font-size: 2.5rem; font-weight: bold;">{{ stats.tong_phim }}</div>
        <div style="opacity: 0.9;">üé¨ T·ªïng phim</div>
    </div>
    <div class="stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); padding: 1.5rem; border-radius: 15px; color: white; text-align: center; box-shadow: 0 4px 15px rgba(245, 87, 108, 0.4);">
        <div style="font-size: 2.5rem; font-weight: bold;">{{ stats.tong_suat_chieu }}</div>
        <div style="opacity: 0.9;">üïê Su·∫•t chi·∫øu</div>
    </div>
    <div class="stat-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); padding: 1.5rem; border-radius: 15px; color: white; text-align: center; box-shadow: 0 4px 15px rgba(79, 172, 254, 0.4);">
        <div style="font-size: 2.5rem; font-weight: bold;">{{ stats.tong_ve_dat }}</div>
        <div style="opacity: 0.9;">üéüÔ∏è V√© ƒë√£ ƒë·∫∑t</div>
    </div>
    <div class="stat-card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); padding: 1.5rem; border-radius: 15px; color: white; text-align: center; box-shadow: 0 4px 15px rgba(67, 233, 123, 0.4);">
        <div style="font-size: 2.5rem; font-weight: bold;">{{ "{:,.0f}".format(stats.tong_doanh_thu) }}</div>
        <div style="opacity: 0.9;">üí∞ Doanh thu (VND)</div>
    </div>
    <div class="stat-card" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); padding: 1.5rem; border-radius: 15px; color: white; text-align: center; box-shadow: 0 4px 15px rgba(250, 112, 154, 0.4);">
        <div style="font-size: 2.5rem; font-weight: bold;">{{ stats.tong_khach_hang }}</div>
        <div style="opacity: 0.9;">üë• Kh√°ch h√†ng</div>
    </div>
</div>

<div class="tabs">
    <button class="tab-btn active" onclick="showTab('movies')">üé¨ Phim</button>
    <button class="tab-btn" onclick="showTab('showtimes')">üïê Su·∫•t chi·∫øu</button>
    <button class="tab-btn" onclick="showTab('bookings')">üéüÔ∏è ƒê·∫∑t v√©</button>
    <button class="tab-btn" onclick="showTab('users')">üë• Ng∆∞·ªùi d√πng</button>
    <button class="tab-btn" onclick="showTab('revenue')">üìä Doanh thu</button>
</div>

<!-- Tab Doanh thu - Top 10 phim -->
<div id="revenue" class="tab-content">
    <h2 style="color: #000;">üìä Top 10 Phim Doanh Thu Cao Nh·∫•t</h2>
    
    <table class="admin-table" style="margin-top: 1rem;">
        <thead>
            <tr>
                <th style="width: 50px;">H·∫°ng</th>
                <th style="width: 80px;">Poster</th>
                <th>T√™n phim</th>
                <th style="text-align: center;">S·ªë v√© b√°n</th>
                <th style="text-align: right;">Doanh thu</th>
            </tr>
        </thead>
        <tbody>
            {% for phim in top_phim %}
            <tr>
                <td style="text-align: center; font-size: 1.5rem; font-weight: bold;">
                    {% if loop.index == 1 %}
                        ü•á
                    {% elif loop.index == 2 %}
                        ü•à
                    {% elif loop.index == 3 %}
                        ü•â
                    {% else %}
                        {{ loop.index }}
                    {% endif %}
                </td>
                <td>
                    {% if phim.poster_url %}
                        <img src="{{ phim.poster_url }}" alt="{{ phim.title }}" style="width: 60px; height: 90px; object-fit: cover; border-radius: 5px;">
                    {% else %}
                        <div style="width: 60px; height: 90px; background: #ddd; border-radius: 5px; display: flex; align-items: center; justify-content: center;">üé¨</div>
                    {% endif %}
                </td>
                <td style="font-weight: 500;">{{ phim.title }}</td>
                <td style="text-align: center;">
                    <span style="background: #e3f2fd; color: #1976d2; padding: 0.25rem 0.75rem; border-radius: 20px; font-weight: bold;">
                        {{ phim.so_ve_ban }} v√©
                    </span>
                </td>
                <td style="text-align: right; font-weight: bold; color: #2e7d32;">
                    {{ "{:,.0f}".format(phim.doanh_thu) }} VND
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="5" style="text-align: center; padding: 2rem; color: #666;">
                    Ch∆∞a c√≥ d·ªØ li·ªáu doanh thu
                </td>
            </tr>
            {% endfor %}
        </tbody>
        <tfoot>
            <tr style="background: #f5f5f5; font-weight: bold;">
                <td colspan="3" style="text-align: right;">T·ªïng c·ªông:</td>
                <td style="text-align: center;">{{ stats.tong_ve_dat }} v√©</td>
                <td style="text-align: right; color: #d32f2f; font-size: 1.1rem;">{{ "{:,.0f}".format(stats.tong_doanh_thu) }} VND</td>
            </tr>
        </tfoot>
    </table>
</div>

<!-- Tab Phim -->
<div id="movies" class="tab-content active">
    <h2 style="color: #000;">Qu·∫£n l√Ω phim</h2>
    
    <form method="POST" action="{{ url_for('admin_add_movie') }}" style="margin: 1rem 0; padding: 1rem; background: #f8f8f8; border: 1px solid #e0e0e0; border-radius: 10px;">
        <h3 style="margin-bottom: 1rem; color: #000;">‚ûï Th√™m phim m·ªõi</h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
            <input type="text" name="title" placeholder="T√™n phim" required style="padding: 0.75rem; background: #fff; border: 1px solid #ddd; border-radius: 5px; color: #000;">
            <input type="text" name="genre" placeholder="Th·ªÉ lo·∫°i" style="padding: 0.75rem; background: #fff; border: 1px solid #ddd; border-radius: 5px; color: #000;">
            <input type="number" name="duration" placeholder="Th·ªùi l∆∞·ª£ng (ph√∫t)" style="padding: 0.75rem; background: #fff; border: 1px solid #ddd; border-radius: 5px; color: #000;">
            <input type="text" name="director" placeholder="ƒê·∫°o di·ªÖn" style="padding: 0.75rem; background: #fff; border: 1px solid #ddd; border-radius: 5px; color: #000;">
            <input type="text" name="cast_members" placeholder="Di·ªÖn vi√™n" style="padding: 0.75rem; background: #fff; border: 1px solid #ddd; border-radius: 5px; color: #000;">
            <input type="url" name="poster_url" placeholder="URL poster" style="padding: 0.75rem; background: #fff; border: 1px solid #ddd; border-radius: 5px; color: #000;">
            <input type="url" name="trailer_url" placeholder="URL trailer (YouTube embed)" style="padding: 0.75rem; background: #fff; border: 1px solid #ddd; border-radius: 5px; color: #000;">
        </div>
        <textarea name="description" placeholder="M√¥ t·∫£" rows="2" style="width: 100%; margin-top: 1rem; padding: 0.75rem; background: #ffffff; border: 1px solid #ddd; border-radius: 5px; color: #000;"></textarea>
        <button type="submit" class="btn btn-success" style="margin-top: 1rem;">‚ûï Th√™m phim</button>
    </form>
    
    <table class="admin-table">
        <thead>
            <tr>
                <th>ID</th>
                <th>T√™n phim</th>
                <th>Th·ªÉ lo·∫°i</th>
                <th>Th·ªùi l∆∞·ª£ng</th>
                <th>ƒê·∫°o di·ªÖn</th>
                <th>Di·ªÖn vi√™n</th>
                <th>H√†nh ƒë·ªông</th>
            </tr>
        </thead>
        <tbody>
            {% for movie in movies %}
            <tr>
                <td>{{ movie.id }}</td>
                <td>{{ movie.title }}</td>
                <td>{{ movie.genre or '-' }}</td>
                <td>{{ movie.duration or '-' }} ph√∫t</td>
                <td>{{ movie.director or '-' }}</td>
                <td>{{ movie.cast_members or '-' }}</td>
                <td>
                    <button type="button" class="btn btn-primary" onclick="openEditModal({{ movie.id }}, '{{ movie.title|e }}', '{{ movie.genre|e if movie.genre else '' }}', {{ movie.duration or 0 }}, '{{ movie.poster_url|e if movie.poster_url else '' }}', '{{ movie.trailer_url|e if movie.trailer_url else '' }}', '{{ movie.description|e if movie.description else '' }}', '{{ movie.director|e if movie.director else '' }}', '{{ movie.cast_members|e if movie.cast_members else '' }}')">‚úèÔ∏è</button>
                    <form method="POST" action="{{ url_for('admin_delete_movie', movie_id=movie.id) }}" style="display: inline;">
                        <button type="submit" class="btn btn-danger" onclick="return confirm('X√≥a phim n√†y?')">üóëÔ∏è</button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Modal S·ª≠a Phim -->
<div id="editMovieModal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; overflow-y: auto;">
    <div style="background: #ffffff; max-width: 600px; margin: 2rem auto; padding: 2rem; border-radius: 15px; position: relative; border: 1px solid #e0e0e0; box-shadow: 0 10px 30px rgba(0,0,0,0.2);">
        <button onclick="closeEditModal()" style="position: absolute; top: 1rem; right: 1rem; background: none; border: none; color: #333; font-size: 1.5rem; cursor: pointer;">‚úï</button>
        <h2 style="margin-bottom: 1.5rem; color: var(--primary);">‚úèÔ∏è S·ª≠a th√¥ng tin phim</h2>
        <form method="POST" action="" id="editMovieForm">
            <div style="display: grid; gap: 1rem;">
                <input type="hidden" name="movie_id" id="edit_movie_id">
                <div class="form-group">
                    <label style="color: #000;">T√™n phim *</label>
                    <input type="text" name="title" id="edit_title" required style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 5px; color: #000; background: #fff;">
                </div>
                <div class="form-group">
                    <label style="color: #000;">Th·ªÉ lo·∫°i</label>
                    <input type="text" name="genre" id="edit_genre" style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 5px; color: #000; background: #fff;">
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label style="color: #000;">Th·ªùi l∆∞·ª£ng (ph√∫t)</label>
                        <input type="number" name="duration" id="edit_duration" style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 5px; color: #000; background: #fff;">
                    </div>
                    <div class="form-group">
                        <label style="color: #000;">ƒê·∫°o di·ªÖn</label>
                        <input type="text" name="director" id="edit_director" style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 5px; color: #000; background: #fff;">
                    </div>
                </div>
                <div class="form-group">
                    <label style="color: #000;">Di·ªÖn vi√™n</label>
                    <input type="text" name="cast_members" id="edit_cast_members" style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 5px; color: #000; background: #fff;">
                </div>
                <div class="form-group">
                    <label style="color: #000;">URL Poster</label>
                    <input type="url" name="poster_url" id="edit_poster_url" style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 5px; color: #000; background: #fff;">
                </div>
                <div class="form-group">
                    <label style="color: #000;">URL Trailer (YouTube embed)</label>
                    <input type="url" name="trailer_url" id="edit_trailer_url" style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 5px; color: #000; background: #fff;">
                </div>
                <div class="form-group">
                    <label style="color: #000;">M√¥ t·∫£</label>
                    <textarea name="description" id="edit_description" rows="3" style="width: 100%; padding: 0.75rem; background: #ffffff; border: 1px solid #ddd; border-radius: 5px; color: #000;"></textarea>
                </div>
                <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                    <button type="submit" class="btn btn-success" style="flex: 1;">üíæ L∆∞u thay ƒë·ªïi</button>
                    <button type="button" onclick="closeEditModal()" class="btn btn-secondary" style="flex: 1;">H·ªßy</button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Tab Su·∫•t chi·∫øu -->
<div id="showtimes" class="tab-content">
    <h2>Qu·∫£n l√Ω su·∫•t chi·∫øu</h2>
    
    <form method="POST" action="{{ url_for('admin_add_showtime') }}" style="margin: 1rem 0; padding: 1rem; background: #f8f8f8; border: 1px solid #e0e0e0; border-radius: 10px;">
        <h3 style="margin-bottom: 1rem; color: #000;">‚ûï Th√™m su·∫•t chi·∫øu</h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
            <select name="movie_id" required style="padding: 0.75rem; background: #fff; border: 1px solid #ddd; border-radius: 5px; color: #000;">
                <option value="">-- Ch·ªçn phim --</option>
                {% for movie in movies %}
                <option value="{{ movie.id }}">{{ movie.title }}</option>
                {% endfor %}
            </select>
            <input type="text" name="theater" placeholder="T√™n r·∫°p" required style="padding: 0.75rem; background: #fff; border: 1px solid #ddd; border-radius: 5px; color: #000;">
            <input type="date" name="show_date" required style="padding: 0.75rem; background: #fff; border: 1px solid #ddd; border-radius: 5px; color: #000;">
            <input type="time" name="show_time" required style="padding: 0.75rem; background: #fff; border: 1px solid #ddd; border-radius: 5px; color: #000;">
            <input type="number" name="price" placeholder="Gi√° v√©" value="75000" required style="padding: 0.75rem; background: #fff; border: 1px solid #ddd; border-radius: 5px; color: #000;">
        </div>
        <button type="submit" class="btn btn-success" style="margin-top: 1rem;">‚ûï Th√™m su·∫•t chi·∫øu</button>
    </form>
    
    <table class="admin-table">
        <thead>
            <tr>
                <th>ID</th>
                <th>Phim</th>
                <th>R·∫°p</th>
                <th>Ng√†y</th>
                <th>Gi·ªù</th>
                <th>Gi√°</th>
                <th>H√†nh ƒë·ªông</th>
            </tr>
        </thead>
        <tbody>
            {% for st in showtimes %}
            <tr>
                <td>{{ st.id }}</td>
                <td>{{ st.title }}</td>
                <td>{{ st.theater }}</td>
                <td>{{ st.show_date }}</td>
                <td>{{ st.show_time }}</td>
                <td>{{ "{:,.0f}".format(st.price) }} VND</td>
                <td>
                    <form method="POST" action="{{ url_for('admin_delete_showtime', showtime_id=st.id) }}" style="display: inline;">
                        <button type="submit" class="btn btn-danger" onclick="return confirm('X√≥a su·∫•t chi·∫øu n√†y?')">üóëÔ∏è</button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Tab ƒê·∫∑t v√© -->
<div id="bookings" class="tab-content">
    <h2>Qu·∫£n l√Ω ƒë·∫∑t v√©</h2>
    
    <table class="admin-table">
        <thead>
            <tr>
                <th>ID</th>
                <th>Ng∆∞·ªùi ƒë·∫∑t</th>
                <th>Phim</th>
                <th>Gh·∫ø</th>
                <th>Ng√†y chi·∫øu</th>
                <th>Tr·∫°ng th√°i</th>
                <th>H√†nh ƒë·ªông</th>
            </tr>
        </thead>
        <tbody>
            {% for b in bookings %}
            <tr>
                <td>{{ b.id }}</td>
                <td>{{ b.username }}</td>
                <td>{{ b.title }}</td>
                <td>{{ b.seat_number }}</td>
                <td>{{ b.show_date }}</td>
                <td>
                    {% if b.status == 'confirmed' %}
                        <span style="color: var(--success);">‚úÖ X√°c nh·∫≠n</span>
                    {% elif b.status == 'cancelled' %}
                        <span style="color: var(--danger);">‚ùå ƒê√£ h·ªßy</span>
                    {% elif b.status == 'expired' %}
                        <span style="color: #6c757d;">‚åõ H·∫øt h·∫°n</span>
                    {% else %}
                        <span style="color: var(--warning);">‚è≥ Ch·ªù</span>
                    {% endif %}
                </td>
                <td>
                    {% if b.status == 'confirmed' %}
                    <form method="POST" action="{{ url_for('admin_cancel_booking', booking_id=b.id) }}" style="display: inline;">
                        <button type="submit" class="btn btn-danger" onclick="return confirm('H·ªßy ƒë·∫∑t v√© n√†y?')">‚ùå</button>
                    </form>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Tab Ng∆∞·ªùi d√πng -->
<div id="users" class="tab-content">
    <h2>Qu·∫£n l√Ω ng∆∞·ªùi d√πng</h2>
    
    <table class="admin-table">
        <thead>
            <tr>
                <th>ID</th>
                <th>Username</th>
                <th>Email</th>
                <th>H·ªç t√™n</th>
                <th>Admin</th>
            </tr>
        </thead>
        <tbody>
            {% for user in users %}
            <tr>
                <td>{{ user.id }}</td>
                <td>{{ user.username }}</td>
                <td>{{ user.email }}</td>
                <td>{{ user.full_name or '-' }}</td>
                <td>{% if user.is_admin %}‚≠ê Admin{% else %}-{% endif %}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<script>
function showTab(tabId) {
    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.getElementById(tabId).classList.add('active');
    event.target.classList.add('active');
}

function openEditModal(id, title, genre, duration, poster, trailer, description, director, cast) {
    document.getElementById('edit_movie_id').value = id;
    document.getElementById('edit_title').value = title;
    document.getElementById('edit_genre').value = genre;
    document.getElementById('edit_duration').value = duration;
    document.getElementById('edit_poster_url').value = poster;
    document.getElementById('edit_trailer_url').value = trailer;
    document.getElementById('edit_description').value = description;
    document.getElementById('edit_director').value = director;
    document.getElementById('edit_cast_members').value = cast;
    document.getElementById('editMovieForm').action = '/admin/edit-movie/' + id;
    document.getElementById('editMovieModal').style.display = 'block';
}

function closeEditModal() {
    document.getElementById('editMovieModal').style.display = 'none';
}

// Close modal when clicking outside
document.getElementById('editMovieModal').addEventListener('click', function(e) {
    if (e.target === this) closeEditModal();
});
</script>
{% endblock %}
